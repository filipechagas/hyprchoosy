name: CI

on:
  pull_request:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  # Release Please - Creates/updates release PR and tags (but skips GitHub release creation)
  release-please:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: rust
          skip-github-release: true

  # Run tests and checks
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --all-features

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Check formatting
        run: cargo fmt -- --check

  # Build binaries for all platforms in parallel
  build-binaries:
    name: Build ${{ matrix.target }}
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'pull_request'
    needs: test
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
          - target: x86_64-unknown-linux-musl
            arch: amd64-musl
          - target: aarch64-unknown-linux-gnu
            arch: arm64
          - target: aarch64-unknown-linux-musl
            arch: arm64-musl
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build release binary
        run: cross build --release --target ${{ matrix.target }}

      - name: Create archive
        run: |
          cd target/${{ matrix.target }}/release
          tar czf hyprchoosy-${{ matrix.arch }}.tar.gz hyprchoosy
          mv hyprchoosy-${{ matrix.arch }}.tar.gz ${{ github.workspace }}/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hyprchoosy-${{ matrix.arch }}
          path: hyprchoosy-${{ matrix.arch }}.tar.gz

  # Build distribution packages in parallel
  build-packages:
    name: Build ${{ matrix.package }} package
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'pull_request'
    needs: build-binaries
    strategy:
      matrix:
        package: [deb, rpm, arch]
    steps:
      - uses: actions/checkout@v4

      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: hyprchoosy-amd64

      - name: Build DEB package
        if: matrix.package == 'deb'
        run: |
          tar xzf hyprchoosy-amd64.tar.gz
          mkdir -p target/release
          cp hyprchoosy target/release/
          cargo install cargo-deb
          cargo deb --no-build --no-strip

      - name: Build RPM package
        if: matrix.package == 'rpm'
        run: |
          tar xzf hyprchoosy-amd64.tar.gz
          sudo apt-get update && sudo apt-get install -y rpm
          
          # Get version from Cargo.toml
          VERSION=$(grep -m1 '^version' Cargo.toml | cut -d'"' -f2)
          
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p ~/rpmbuild/BUILDROOT/hyprchoosy-${VERSION}-1.x86_64/usr/bin
          cp hyprchoosy ~/rpmbuild/BUILDROOT/hyprchoosy-${VERSION}-1.x86_64/usr/bin/
          chmod +x ~/rpmbuild/BUILDROOT/hyprchoosy-${VERSION}-1.x86_64/usr/bin/hyprchoosy
          
          CURRENT_DATE=$(date "+%a %b %d %Y")
          cat > ~/rpmbuild/SPECS/hyprchoosy.spec << EOF
          Name:           hyprchoosy
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        Route links to different browsers by client and host for Hyprland
          License:        MIT
          URL:            https://github.com/filipechagas/hyprchoosy
          BuildArch:      x86_64

          %description
          Route links to different browsers by client and host for Hyprland

          %install
          # Files already in BUILDROOT

          %files
          /usr/bin/hyprchoosy

          %changelog
          * $CURRENT_DATE Builder <builder@example.com> - ${VERSION}-1
          - Package version ${VERSION}
          EOF
          
          rpmbuild -bb ~/rpmbuild/SPECS/hyprchoosy.spec
          cp ~/rpmbuild/RPMS/x86_64/*.rpm .

      - name: Build Arch package
        if: matrix.package == 'arch'
        run: |
          VERSION=$(grep -m1 '^version' Cargo.toml | cut -d'"' -f2)
          
          cat > PKGBUILD << 'EOF'
          # Maintainer: Filipe Chagas <filipechagas@pm.me>
          pkgname=hyprchoosy
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc="Route links to different browsers by client and host for Hyprland"
          arch=('x86_64')
          url="https://github.com/filipechagas/hyprchoosy"
          license=('MIT')
          depends=()
          source=("hyprchoosy-amd64.tar.gz")
          sha256sums=('SKIP')

          package() {
            install -Dm755 "$srcdir/hyprchoosy" "$pkgdir/usr/bin/hyprchoosy"
          }
          EOF
          
          # Replace VERSION placeholder
          sed -i "s/\${VERSION}/$VERSION/g" PKGBUILD
          
          docker run --rm -v "$PWD:/pkg" archlinux:latest /bin/bash -c "
            pacman -Sy --noconfirm base-devel &&
            useradd -m builder &&
            chown -R builder:builder /pkg &&
            cd /pkg &&
            su builder -c 'makepkg --noconfirm'
          "

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: hyprchoosy-${{ matrix.package }}
          path: |
            target/debian/*.deb
            *.rpm
            *.pkg.tar.zst

  # Create GitHub release with all assets after builds complete
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [release-please, build-binaries, build-packages]
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Display structure
        run: ls -R

      - name: Create release with assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            hyprchoosy-*/*.tar.gz
            hyprchoosy-*/*.deb
            hyprchoosy-*/*.rpm
            hyprchoosy-*/*.pkg.tar.zst
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
